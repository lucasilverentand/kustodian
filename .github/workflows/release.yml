name: Release

on:
  workflow_run:
    workflows: ['CI']
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      publish:
        description: 'Force publish (skip release-please check)'
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  release-please:
    name: Release Please
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    outputs:
      releases_created: ${{ steps.release.outputs.releases_created }}
      paths_released: ${{ steps.release.outputs.paths_released }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  build:
    name: Build
    needs: release-please
    if: needs.release-please.outputs.releases_created == 'true' || (github.event_name == 'workflow_dispatch' && inputs.publish == true)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Build all packages
        run: bun run build

      - uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            dist/
            plugins/*/dist/

  publish-npm:
    name: Publish to npm (${{ matrix.package }})
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - package: kustodian
            path: '.'
          - package: plugin-authelia
            path: plugins/authelia
          - package: plugin-k0s
            path: plugins/k0s
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: Publish ${{ matrix.package }}
        working-directory: ${{ matrix.path }}
        run: |
          name=$(jq -r .name package.json)
          version=$(jq -r .version package.json)
          echo "Publishing $name@$version"
          if output=$(npm publish --provenance --access public 2>&1); then
            echo "✅ Published $name@$version"
          else
            if echo "$output" | grep -q "cannot publish over the previously published"; then
              echo "⏭️ Skipped $name@$version (already published)"
            else
              echo "❌ Failed to publish $name@$version"
              echo "$output"
              exit 1
            fi
          fi

  publish-github:
    name: Publish to GitHub Packages (${{ matrix.package }})
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - package: kustodian
            path: '.'
            scoped_name: '@lucasilverentand/kustodian'
          - package: plugin-authelia
            path: plugins/authelia
            scoped_name: '@lucasilverentand/plugin-authelia'
          - package: plugin-k0s
            path: plugins/k0s
            scoped_name: '@lucasilverentand/plugin-k0s'
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2

      - uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: Publish ${{ matrix.package }}
        working-directory: ${{ matrix.path }}
        run: |
          version=$(jq -r .version package.json)
          jq --arg name "${{ matrix.scoped_name }}" '.name = $name' package.json > package.json.tmp
          mv package.json.tmp package.json
          echo "Publishing ${{ matrix.scoped_name }}@$version"
          if output=$(bun publish --access public --registry https://npm.pkg.github.com 2>&1); then
            echo "✅ Published ${{ matrix.scoped_name }}@$version"
          else
            if echo "$output" | grep -q "cannot publish over the previously published"; then
              echo "⏭️ Skipped ${{ matrix.scoped_name }}@$version (already published)"
            else
              echo "❌ Failed to publish ${{ matrix.scoped_name }}@$version"
              echo "$output"
              exit 1
            fi
          fi
        env:
          BUN_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
