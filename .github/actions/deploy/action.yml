name: Kustodian Deploy
description: Deploy kustodian configuration to a Kubernetes cluster via OCI

branding:
  icon: upload-cloud
  color: blue

inputs:
  cluster:
    description: Cluster name to deploy
    required: true
  working-directory:
    description: Project root path
    required: false
    default: '.'
  dry-run:
    description: Preview without making changes
    required: false
    default: 'false'
  skip-bootstrap:
    description: Skip cluster bootstrap
    required: false
    default: 'true'
  skip-flux:
    description: Skip Flux installation
    required: false
    default: 'false'
  kubeconfig:
    description: Base64-encoded kubeconfig
    required: false
    default: ''
  oci-registry:
    description: OCI registry URL
    required: false
    default: 'ghcr.io'
  oci-username:
    description: Registry username
    required: false
    default: ${{ github.actor }}
  oci-password:
    description: Registry password/token
    required: false
    default: ''
  doppler-token:
    description: Doppler service token
    required: false
    default: ''
  kustodian-version:
    description: Kustodian CLI version
    required: false
    default: 'latest'
  bun-version:
    description: Bun version
    required: false
    default: '1.3.5'

outputs:
  deployed:
    description: Whether deployment succeeded (true/false)
    value: ${{ steps.deploy.outputs.deployed }}
  oci-artifact:
    description: Pushed OCI artifact URL
    value: ${{ steps.deploy.outputs.oci-artifact }}

runs:
  using: composite
  steps:
    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: ${{ inputs.bun-version }}

    - name: Setup Flux CLI
      uses: fluxcd/flux2/action@main

    - name: Configure kubeconfig
      if: inputs.kubeconfig != ''
      shell: bash
      run: |
        mkdir -p ~/.kube
        echo "${{ inputs.kubeconfig }}" | base64 -d > ~/.kube/config
        chmod 600 ~/.kube/config
        echo "KUBECONFIG=${HOME}/.kube/config" >> "$GITHUB_ENV"

    - name: Login to OCI registry
      if: inputs.oci-password != ''
      shell: bash
      run: |
        echo "${{ inputs.oci-password }}" | flux oci login "${{ inputs.oci-registry }}" \
          --username="${{ inputs.oci-username }}" \
          --password-stdin

    - name: Deploy configuration
      id: deploy
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      env:
        DOPPLER_TOKEN: ${{ inputs.doppler-token }}
      run: |
        # Build CLI command
        CLI_VERSION="${{ inputs.kustodian-version }}"
        if [ "$CLI_VERSION" = "latest" ]; then
          CLI_PACKAGE="kustodian"
        else
          CLI_PACKAGE="kustodian@${CLI_VERSION}"
        fi

        # Build apply command with flags
        APPLY_CMD="bunx ${CLI_PACKAGE} apply --cluster ${{ inputs.cluster }}"

        if [ "${{ inputs.dry-run }}" = "true" ]; then
          APPLY_CMD="${APPLY_CMD} --dry-run"
        fi

        if [ "${{ inputs.skip-bootstrap }}" = "true" ]; then
          APPLY_CMD="${APPLY_CMD} --skip-bootstrap"
        fi

        if [ "${{ inputs.skip-flux }}" = "true" ]; then
          APPLY_CMD="${APPLY_CMD} --skip-flux"
        fi

        # Run deployment
        echo "Running: ${APPLY_CMD}"
        if OUTPUT=$(${APPLY_CMD} 2>&1); then
          echo "deployed=true" >> "$GITHUB_OUTPUT"
          echo "✓ Deployment succeeded"
          echo "${OUTPUT}"

          # Extract OCI artifact URL from output if present
          OCI_URL=$(echo "${OUTPUT}" | grep -oE 'oci://[^ ]+' | head -1 || true)
          if [ -n "${OCI_URL}" ]; then
            echo "oci-artifact=${OCI_URL}" >> "$GITHUB_OUTPUT"
            echo "OCI artifact: ${OCI_URL}"
          fi
        else
          echo "deployed=false" >> "$GITHUB_OUTPUT"
          echo "✗ Deployment failed"
          echo "${OUTPUT}"
          exit 1
        fi
