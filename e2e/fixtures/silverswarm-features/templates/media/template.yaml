apiVersion: kustodian.io/v1
kind: Template
metadata:
  name: media
spec:
  # Template-level node requirements
  requirements:
    - type: nodeLabel
      key: silverswarm.io/media-downloaders
      value: "true"
      atLeast: 1
    - type: nodeLabel
      key: silverswarm.io/media-vpn
      value: "true"
      atLeast: 1

  kustomizations:
    # VPN proxy for media services
    - name: arr-proxy
      path: ./arr-proxy
      namespace:
        default: media
        create: true
      substitutions:
        - type: version
          name: privado_proxy_version
          default: "latest"
          registry:
            type: dockerhub
            image: privado/proxy
        - name: replicas
          default: "1"
        - name: privado_server
          default: nl-ams
      depends_on:
        # Cross-template dependency
        - secrets/doppler
      health_checks:
        - kind: Deployment
          name: arr-proxy
          api_version: apps/v1
          namespace: media

    # Shared NFS storage
    - name: shared-storage
      path: ./shared-storage
      namespace:
        default: media
      substitutions:
        - name: ing_nfs_server
        - name: ing_nfs_media_path
        - name: ams_nfs_server
        - name: ams_nfs_media_path
      health_checks:
        - kind: PersistentVolumeClaim
          name: shared-ams-media
          api_version: v1
          namespace: media
        - kind: PersistentVolumeClaim
          name: shared-ing-media
          api_version: v1
          namespace: media
      depends_on:
        # Raw dependency - assuming external storage operator exists
        - raw:
            name: nfs-csi-driver
            namespace: kube-system

    # qBittorrent with auth configuration
    - name: qbittorrent
      path: ./qbittorrent
      namespace:
        default: media
      substitutions:
        - type: version
          name: qbittorrent_version
          default: "5.1.2-r3-ls421"
          registry:
            type: dockerhub
            image: linuxserver/qbittorrent
        - type: version
          name: tun2socks_version
          default: "v2.5.2"
          registry:
            type: ghcr
            image: xjasonlyu/tun2socks
        - name: cluster_domain
        - name: default_timezone
          default: Europe/Amsterdam
          preserve_case: true
        - name: claim_name_media
          default: shared-media
        - name: storage_class
          default: longhorn-retain-single
        - name: storage_size
          default: "1Gi"
          preserve_case: true
      # Auth configuration for proxy-based SSO
      auth:
        provider: authelia
        type: proxy
        app_name: qbittorrent
        app_display_name: qBittorrent
        app_description: BitTorrent client
        app_icon: https://raw.githubusercontent.com/qbittorrent/qBittorrent/master/src/icons/qbittorrent-tray.svg
        app_group: Media Download
        config:
          external_host: https://qbittorrent.${cluster_domain}
          internal_host: http://qbittorrent.${namespace}.svc.cluster.local:8080
      depends_on:
        - arr-proxy
        - shared-storage
        # Cross-template dependencies
        - secrets/doppler
        # Assuming these templates exist
        - raw:
            name: ingress-nginx
            namespace: ingress-nginx
      health_checks:
        - kind: Deployment
          name: qbittorrent
          api_version: apps/v1
          namespace: media

    # SABnzbd with different auth configuration
    - name: sabnzbd
      path: ./sabnzbd
      namespace:
        default: media
      substitutions:
        - type: version
          name: sabnzbd_version
          default: "4.5.4-ls235"
          registry:
            type: dockerhub
            image: linuxserver/sabnzbd
        - type: version
          name: tun2socks_version
          default: "v2.5.2"
          registry:
            type: ghcr
            image: xjasonlyu/tun2socks
        - name: cluster_domain
        - name: default_timezone
          default: Europe/Amsterdam
          preserve_case: true
        - name: claim_name_media
          default: shared-media
        - name: storage_class
          default: longhorn-retain-single
        - name: storage_size
          default: "1Gi"
          preserve_case: true
        - name: news_server
          default: news.eweka.nl
        - name: news_port
          default: "563"
      # Different auth provider
      auth:
        provider: authentik
        type: oauth2
        app_name: sabnzbd
        app_display_name: SABnzbd
        app_description: Usenet binary newsreader
        app_icon: https://raw.githubusercontent.com/sabnzbd/sabnzbd/develop/icons/logo-arrow.svg
        app_group: Media Download
        config:
          external_host: https://sabnzbd.${cluster_domain}
          internal_host: http://sabnzbd.${namespace}.svc.cluster.local:8080
          redirect_uris:
            - https://sabnzbd.${cluster_domain}/oauth/callback
      depends_on:
        - arr-proxy
        - shared-storage
        - secrets/doppler
      health_checks:
        - kind: Deployment
          name: sabnzbd
          api_version: apps/v1
          namespace: media
