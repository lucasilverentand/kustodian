apiVersion: kustodian.io/v1
kind: Template
metadata:
  name: secrets
spec:
  kustomizations:
    # Base secret operator
    - name: doppler
      path: ./doppler
      namespace:
        default: doppler-operator-system
        create: true
      substitutions:
        - type: helm
          name: doppler_version
          default: "1.6.0"
          helm:
            repository: https://helm.doppler.com
            chart: doppler-kubernetes-operator
      health_checks:
        - kind: Deployment
          name: doppler-operator-controller-manager
          api_version: helm.toolkit.fluxcd.io/v2
          namespace: doppler-operator-system

    # Replicator - depends on doppler being ready
    - name: replicator
      path: ./replicator
      namespace:
        default: replicator-system
        create: true
      depends_on:
        - doppler
      substitutions:
        - type: helm
          name: replicator_version
          default: "2.12.0"
          helm:
            oci: oci://ghcr.io/mittwald/charts
            chart: kubernetes-replicator
      health_checks:
        - kind: Deployment
          name: kubernetes-replicator
          api_version: apps/v1
          namespace: replicator-system

    # External secrets store configuration
    - name: external-secrets-store
      path: ./external-secrets-store
      depends_on:
        - replicator
      wait: false
      prune: false
