apiVersion: kustodian.io/v1
kind: Cluster
metadata:
  name: test-cluster
spec:
  # Required domain field
  domain: test.example.com

  # OCI mode for testing OCI repository generation
  oci:
    registry: ghcr.io
    repository: test-org/kustodian
    tag_strategy: manual
    tag: latest

  # Secret provider configuration
  secrets:
    doppler:
      project: infrastructure
      config: test-cluster
    onepassword:
      vault: infrastructure

  # Template configurations with per-kustomization overrides
  templates:
    - name: secrets
      enabled: true
      values:
        doppler_version: "1.7.0"  # Override default
        replicator_version: "2.13.0"
      kustomizations:
        # Keep doppler enabled (simple boolean)
        doppler: true
        # Enable replicator with stateful preservation (object)
        replicator:
          enabled: true
          preservation:
            mode: stateful
        # Disable external-secrets-store (simple boolean)
        external-secrets-store: false

    - name: database
      enabled: true
      values:
        postgresql_version: "17.2"
        cluster_name: test-db-cluster
        instances: "3"
        storage_size: "20Gi"
        storage_class: local-path
        db_name: testdb
        db_user: testuser
      kustomizations:
        # CNPG operator enabled
        cnpg: true
        # App database with custom preservation
        app-db:
          enabled: true
          preservation:
            mode: custom
            keep_resources:
              - PersistentVolumeClaim
              - Secret

    - name: media
      enabled: true
      values:
        cluster_domain: test.example.com
        default_timezone: Europe/Amsterdam
        privado_proxy_version: "1.2.3"
        qbittorrent_version: "5.1.3"
        sabnzbd_version: "4.5.5"
        tun2socks_version: "v2.5.2"
        storage_class: longhorn-retain
        storage_size: "2Gi"
        claim_name_media: shared-media
        # NFS configuration
        ing_nfs_server: 192.168.1.100
        ing_nfs_media_path: /mnt/media
        ams_nfs_server: 192.168.2.100
        ams_nfs_media_path: /mnt/media
        news_server: news.test.nl
        news_port: "563"
      kustomizations:
        # All media kustomizations
        arr-proxy: true
        shared-storage:
          enabled: true
          preservation:
            mode: stateful  # Don't delete PVCs when disabled
        qbittorrent: true
        # SABnzbd disabled for this cluster
        sabnzbd:
          enabled: false
          preservation:
            mode: stateful
